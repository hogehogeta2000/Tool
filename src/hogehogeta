let
    // Step 1: トランザクションテーブルから最小日付と最大日付を取得
    TransactionTable = sales_performance,
    
    // 日付列を実際の日付型に変換
    ConvertedDates = Table.TransformColumns(TransactionTable, {{"transaction_date", each Date.FromText(_), type date}}),
    
    // 最小日付と最大日付を取得
    MinDate = List.Min(ConvertedDates[transaction_date]),
    MaxDate = List.Max(ConvertedDates[transaction_date]),
    
    // 日付範囲を月初から月末まで拡張（オプション）
    StartDate = Date.StartOfMonth(MinDate),
    EndDate = Date.EndOfMonth(MaxDate),
    
    // Step 2: 日付リストを作成
    DateList = List.Dates(StartDate, Duration.Days(EndDate - StartDate) + 1, #duration(1,0,0,0)),
    
    // Step 3: テーブルに変換
    DateTable = Table.FromList(DateList, Splitter.SplitByNothing(), {"Date"}, null, ExtraValues.Error),
    
    // Step 4: 必要な列を一括で追加
    CalendarTable = Table.AddColumn(DateTable, "Year", each Date.Year([Date]), Int64.Type),
    AddMonth = Table.AddColumn(CalendarTable, "Month", each Date.Month([Date]), Int64.Type),
    AddMonthName = Table.AddColumn(AddMonth, "MonthName", each Date.MonthName([Date]), type text),
    AddMonthNameShort = Table.AddColumn(AddMonthName, "MonthNameShort", each Date.ToText([Date], "MMM"), type text),
    AddQuarter = Table.AddColumn(AddMonthNameShort, "Quarter", each "Q" & Text.From(Date.QuarterOfYear([Date])), type text),
    AddQuarterNumber = Table.AddColumn(AddQuarter, "QuarterNumber", each Date.QuarterOfYear([Date]), Int64.Type),
    AddDay = Table.AddColumn(AddQuarterNumber, "Day", each Date.Day([Date]), Int64.Type),
    AddDayOfWeek = Table.AddColumn(AddDay, "DayOfWeek", each Date.DayOfWeek([Date], Day.Monday) + 1, Int64.Type),
    AddDayName = Table.AddColumn(AddDayOfWeek, "DayName", each Date.DayOfWeekName([Date]), type text),
    AddDayNameShort = Table.AddColumn(AddDayName, "DayNameShort", each Date.ToText([Date], "ddd"), type text),
    AddWeekOfYear = Table.AddColumn(AddDayNameShort, "WeekOfYear", each Date.WeekOfYear([Date]), Int64.Type),
    AddDayOfYear = Table.AddColumn(AddWeekOfYear, "DayOfYear", each Date.DayOfYear([Date]), Int64.Type),
    
    // 年月表示用
    AddYearMonth = Table.AddColumn(AddDayOfYear, "YearMonth", each Text.From([Year]) & "-" & Text.PadStart(Text.From([Month]), 2, "0"), type text),
    AddYearQuarter = Table.AddColumn(AddYearMonth, "YearQuarter", each Text.From([Year]) & "-" & [Quarter], type text),
    
    // 週末/平日フラグ
    AddIsWeekend = Table.AddColumn(AddYearQuarter, "IsWeekend", each [DayOfWeek] = 6 or [DayOfWeek] = 7, type logical),
    AddIsWeekday = Table.AddColumn(AddIsWeekend, "IsWeekday", each not [IsWeekend], type logical),
    
    // 営業日フラグ（平日のみ、祝日は考慮しない）
    AddIsBusinessDay = Table.AddColumn(AddIsWeekday, "IsBusinessDay", each [IsWeekday], type logical),
    
    // 月の開始日・終了日
    AddMonthStart = Table.AddColumn(AddIsWeekday, "MonthStart", each Date.StartOfMonth([Date]), type date),
    AddMonthEnd = Table.AddColumn(AddMonthStart, "MonthEnd", each Date.EndOfMonth([Date]), type date),
    
    // 四半期の開始日・終了日
    AddQuarterStart = Table.AddColumn(AddMonthEnd, "QuarterStart", each Date.StartOfQuarter([Date]), type date),
    AddQuarterEnd = Table.AddColumn(AddQuarterStart, "QuarterEnd", each Date.EndOfQuarter([Date]), type date),
    
    // 年の開始日・終了日
    AddYearStart = Table.AddColumn(AddQuarterEnd, "YearStart", each Date.StartOfYear([Date]), type date),
    AddYearEnd = Table.AddColumn(AddYearStart, "YearEnd", each Date.EndOfYear([Date]), type date),
    
    // 相対日付（今日からの日数）
    AddDaysFromToday = Table.AddColumn(AddYearEnd, "DaysFromToday", each Duration.Days([Date] - Date.From(DateTime.LocalNow())), Int64.Type),
    
    // 月別営業日インデックスを効率的に追加
    // Step 1: 営業日のみをフィルタリング
    BusinessDaysOnly = Table.SelectRows(AddDaysFromToday, each [IsBusinessDay] = true),
    
    // Step 2: 年月でグループ化して、各グループにインデックスを追加
    GroupedByMonth = Table.Group(BusinessDaysOnly, {"YearMonth"}, {
        {"BusinessDaysInGroup", each Table.AddIndexColumn(_, "BusinessDayIndexInMonth", 1, 1)}
    }),
    
    // Step 3: グループを展開
    ExpandedBusinessDays = Table.ExpandTableColumn(GroupedByMonth, "BusinessDaysInGroup", 
        Table.ColumnNames(BusinessDaysOnly) & {"BusinessDayIndexInMonth"}),
    
    // Step 4: 元のテーブルと結合（Left Join）
    AddBusinessDayIndex = Table.NestedJoin(AddDaysFromToday, {"Date"}, ExpandedBusinessDays, {"Date"}, "BusinessDayData", JoinKind.LeftOuter),
    ExpandBusinessDayIndex = Table.ExpandTableColumn(AddBusinessDayIndex, "BusinessDayData", {"BusinessDayIndexInMonth"}),
    
    // 月内の営業日数を効率的に計算
    // Step 1: 年月ごとの営業日数を計算
    BusinessDayCountByMonth = Table.Group(
        Table.SelectRows(AddDaysFromToday, each [IsBusinessDay] = true), 
        {"YearMonth"}, 
        {{"BusinessDaysCount", each Table.RowCount(_), Int64.Type}}
    ),
    
    // Step 2: 元のテーブルと結合してBusinessDaysInMonth列を追加
    JoinWithBusinessDayCount = Table.NestedJoin(ExpandBusinessDayIndex, {"YearMonth"}, BusinessDayCountByMonth, {"YearMonth"}, "BusinessDayCountData", JoinKind.LeftOuter),
    AddBusinessDaysInMonth = Table.ExpandTableColumn(JoinWithBusinessDayCount, "BusinessDayCountData", {"BusinessDaysCount"}),
    RenameBusinessDaysColumn = Table.RenameColumns(AddBusinessDaysInMonth, {{"BusinessDaysCount", "BusinessDaysInMonth"}}),
    
    // 日付をソート
    SortedTable = Table.Sort(RenameBusinessDaysColumn, {{"Date", Order.Ascending}})

in
    SortedTable
