# Power Automateフロー設計仕様書

## 1. トリガーと入力パラメータ
### トリガー
- Power Apps からの手動トリガー

### 入力パラメータ
- ステータスコード (数値)
- JSONファイルID (文字列)
- SharePoint ListsのID (数値)
- PowerAppsのリンクURL (文字列)

## 2. メインフロー

### 2.1 JSONファイル取得処理
```
アクション: SharePointファイル取得
入力:
  - サイトアドレス: {サイトURL}
  - ライブラリ名: {ドキュメントライブラリ名}
  - ファイルID: {JSONファイルID}
オプション:
  - コンテンツタイプの予測: オフ
```

### 2.2 JSONパース処理
```
アクション: JSONのパース
入力:
  - コンテンツ: {ファイル取得結果のコンテンツ}
```

### 2.3 ワークフロー送信先の取得
```
アクション: 配列のフィルター
入力:
  - 配列: {パースしたJSONの配列}
  - 条件: @equals(item()?['statusCode'], triggerBody()?['statusCode'])
```

### 2.4 メール送信
```
アクション: メール送信 (Office 365 Outlook)
入力:
  - 宛先: {フィルターした配列の送信先メールアドレス}
  - 件名: "ワークフロー通知 - {ステータス名}"
  - 本文: "
    新しいワークフローが作成されました。
    ステータス: {ステータス名}
    
    以下のリンクから確認してください：
    {PowerAppsのリンクURL}
    "
```

## 3. エラーハンドリング

### 3.1 全体のエラーハンドリング
```
スコープ: トライ-キャッチ
  トライ:
    - メインフローの全処理
  キャッチ:
    条件分岐:
      - JSONファイル不存在エラー
      - JSONパースエラー
      - メール送信エラー
      - その他のエラー
```

### 3.2 エラーログ保存処理
```
アクション: SharePointファイル作成
入力:
  - サイトアドレス: {サイトURL}
  - ライブラリ名: "ErrorLogs"
  - ファイル名: "@{formatDateTime(utcNow(), 'yyyy-MM-dd-HH-mm-ss')}_error.json"
  - ファイルコンテンツ: {
      "timestamp": "@{utcNow()}",
      "errorType": "{エラータイプ}",
      "errorMessage": "{エラーメッセージ}",
      "statusCode": "{入力パラメータのステータスコード}",
      "jsonFileId": "{入力パラメータのJSONファイルID}",
      "listId": "{入力パラメータのListsID}"
    }
```

## 4. エラーパターンと対応

### 4.1 JSONファイル不存在エラー
- エラー内容：指定されたIDのファイルが存在しない
- 対応：エラーログを保存し、フローを終了

### 4.2 JSONパースエラー
- エラー内容：JSONの形式が不正
- 対応：エラーログを保存し、フローを終了

### 4.3 メール送信エラー
- エラー内容：メール送信に失敗
- 対応：3回までリトライを実行
- リトライ失敗時：エラーログを保存し、フローを終了

### 4.4 その他のエラー
- エラー内容：予期せぬエラー
- 対応：エラーログを保存し、フローを終了

```
{
  "metadata": {
    "timestamp": "2024-12-10T10:30:45.123Z",
    "flowRunId": "08585772-6f3c-4e36-a9dd-b9c49a443141",
    "environment": "Production"
  },
  "request": {
    "statusCode": 100,
    "jsonFileId": "doc-123456",
    "listId": "list-789012"
  },
  "error": {
    "step": "JSONファイル取得",
    "type": "FileNotFound",
    "message": "指定されたJSONファイルが見つかりません",
    "details": "ファイルID 'doc-123456' は存在しません"
  }
}
```
